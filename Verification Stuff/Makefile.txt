# -----------------------------------------------------------
# RISC-V Verification Makefile (Synopsys VCS)
# -----------------------------------------------------------

# 1. Compilation Flags
# -sverilog: Enable SystemVerilog
# -full64:   Run in 64-bit mode
# -timescale: Ensure timing precision is set
COMPFLAGS = -sverilog -full64 -timescale=1ns/1ps

# 2. Waveform Debugging (make run WAVE=1)
# -debug_access+all: Enables full visibility for Verdi/DVE
# +define+WAVES:     Can be used in SV code to trigger specific dump logic
ifeq ($(WAVE),1)
	COMPFLAGS += -debug_access+all +define+WAVES
endif

# 3. Coverage Flags (make run COV=1)
# -cm ...: Enables Code Coverage (Line, Condition, Branch, Toggle)
# We pass this to both Compilation (vcs) and Simulation (./simv)
ifeq ($(COV),1)
	COVOPTS += -cm line+cond+branch+tgl
endif

# 4. Test Selection (make run TEST=DIRECTED)
# This appends the test name to the runtime arguments
# Example: ./simv +DIRECTED
ifdef TEST
	RUNOPTS += +$(TEST)
endif

# -----------------------------------------------------------
# Targets
# -----------------------------------------------------------

# Compile Step
compile:
	vcs $(COMPFLAGS) $(COVOPTS) -f filelist.f

# Run Step (Depends on Compile)
run: compile 
	./simv $(RUNOPTS) $(COVOPTS)

# View Waveforms (Verdi)
# Opens the VCD file generated by our tb_top.sv
waves:
	verdi -ssf verification.vcd

# Clean Up
clean:
	rm -rf csrc simv* novas* ucli* *.fsdb *.vcd verdi* *.vdb